<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content=""><title>penwrté…ç½®l2tp/ipsec VPN III | Xçš„ç¬”è®°æœ¬</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><meta name="generator" content="Hexo 4.0.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">penwrté…ç½®l2tp/ipsec VPN III</h1><a id="logo" href="/.">Xçš„ç¬”è®°æœ¬</a><p class="description"></p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> é¦–é¡µ</i></a><a href="/archives/"><i class="fa fa-archive"> å½’æ¡£</i></a><a href="/about/"><i class="fa fa-user"> å…³äº</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">penwrté…ç½®l2tp/ipsec VPN III</h1><div class="post-meta">Oct 22, 2019<span> | </span><span class="category"><a href="/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/">çæŠ˜è…¾</a></span></div><div class="clear"><div class="toc-article" id="toc"><div class="toc-title">æ–‡ç« ç›®å½•</div><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#why"><span class="toc-number">1.</span> <span class="toc-text">Why</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å†å†å‡ºå‘"><span class="toc-number">2.</span> <span class="toc-text">å†å†å‡ºå‘</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ¢³ç†è‡ªåŠ¨è„šæœ¬"><span class="toc-number">3.</span> <span class="toc-text">æ¢³ç†è‡ªåŠ¨è„šæœ¬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vpnsetup-shä¸»æ–‡ä»¶"><span class="toc-number">3.1.</span> <span class="toc-text">vpnsetup.shä¸»æ–‡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vpnsetup-å‡½æ•°"><span class="toc-number">3.2.</span> <span class="toc-text">vpnsetup()å‡½æ•°</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ‰‹åŠ¨æµç¨‹"><span class="toc-number">4.</span> <span class="toc-text">æ‰‹åŠ¨æµç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å®‰è£…éœ€æ±‚åŒ…"><span class="toc-number">4.1.</span> <span class="toc-text">å®‰è£…éœ€æ±‚åŒ…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è®¾ç½®å˜é‡"><span class="toc-number">4.2.</span> <span class="toc-text">è®¾ç½®å˜é‡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®‰è£…vpnè½¯ä»¶"><span class="toc-number">4.3.</span> <span class="toc-text">å®‰è£…VPNè½¯ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å®‰è£…sshé˜²æŠ¤è½¯ä»¶"><span class="toc-number">4.4.</span> <span class="toc-text">å®‰è£…SSHé˜²æŠ¤è½¯ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åˆ¶ä½œå¹¶å®‰è£…libreswan"><span class="toc-number">4.5.</span> <span class="toc-text">åˆ¶ä½œå¹¶å®‰è£…libreswan</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™vpné…ç½®æ–‡ä»¶"><span class="toc-number">4.6.</span> <span class="toc-text">ç¼–å†™VPNé…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etc-ipsec-conf"><span class="toc-number">4.7.</span> <span class="toc-text">/etc/ipsec.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etc-ipsec-secrets"><span class="toc-number">4.8.</span> <span class="toc-text">/etc/ipsec.secrets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etc-ppp-chap-secrets"><span class="toc-number">4.9.</span> <span class="toc-text">/etc/ppp/chap-secrets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å†™å…¥-etc-ipsec-d-passwd"><span class="toc-number">4.10.</span> <span class="toc-text">å†™å…¥ /etc/ipsec.d/passwd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#etc-sysctl-conf"><span class="toc-number">4.11.</span> <span class="toc-text">/etc/sysctl.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ›´æ–°iptables"><span class="toc-number">4.12.</span> <span class="toc-text">æ›´æ–°iptables</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åè®°"><span class="toc-number">5.</span> <span class="toc-text">åè®°</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#äº‹æƒ…æ²¡åšå®Œ-ç„¶åæˆ‘æ”¾å¼ƒäº†-å› ä¸ºæˆ‘åšäº†ä¸‹é¢è¿™ä»¶äº‹-penwrté…ç½®ss-server"><span class="toc-number">6.</span> <span class="toc-text">äº‹æƒ…æ²¡åšå®Œï¼Œç„¶åæˆ‘æ”¾å¼ƒäº†ï¼Œå› ä¸ºæˆ‘åšäº†ä¸‹é¢è¿™ä»¶äº‹ penwrté…ç½®ss-server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#å‚è€ƒèµ„æ–™"><span class="toc-number">7.</span> <span class="toc-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div></div><div class="post-content"><p><a href="c738ae61">penwrté…ç½®l2tp/ipsec VPN II</a></p>
<h2 id="why"><a class="header-anchor" href="#why"></a>Why</h2>
<p>åŠå…¬ç½‘ç»œç»‘å®šäº†ç‰©ç†ç½‘å¡ï¼Œåˆæ²¡æœ‰ç»™WIFIï¼Œç¡®å¾ˆæ— ç¤¼çš„ç»å¸¸åœ¨åŠå…¬ä¸­ä½¿ç”¨æ‰‹æœºå¾®ä¿¡è”ç»œå·¥ä½œã€‚ç®€å•çš„å…±äº«çƒ­ç‚¹ï¼Œå› ä¸ºMACçš„åŸå› ï¼Œæ‰‹æœºä»ç„¶æ²¡æœ‰ç½‘ç»œä½¿ç”¨ã€‚å±‚å°è¯•ç”¨ä»£ç†è§£å†³ã€‚æ‰‹æœºè®¾ç½®ä»£ç†ï¼Œä»…éƒ¨åˆ†è½¯ä»¶èƒ½å¤Ÿé€šè¿‡ä»£ç†ä½¿ç”¨ç½‘ç»œï¼Œä½†ä¸€äº›è›®æ¨ªçš„æ¶éœ¸ä»ç„¶ä¸ç®¡ä¸é¡¾çš„å‘Šè¯‰æˆ‘æ²¡æœ‰ç½‘ç»œè¿æ¥ã€‚åªå¥½å°è¯•åœ¨æœ¬åœ°æä¾›VPNå°†ç½‘ç»œæ‰“é€šã€‚</p>
<p>ä¸ºäº†ä¸æ‰“æ‰°å·¥ä½œï¼Œæˆ‘åœ¨å·¥ä½œè®¡ç®—æœºä¸Šç”¨VBOXæ­å»ºäº†openwrtã€‚ä½¿ç”¨~~l2tp/~~ipsecï¼Œæ‰‹æœºå¯ä»¥å…å®¢æˆ·ç«¯ä½¿ç”¨VPNï¼Œæ¯”è¾ƒæ–¹ä¾¿ã€‚æ‰‹æœºä¸Šå®‰è£…æœ‰â€œå­¦ä¹ å¼ºå›½â€ï¼Œæ‰€ä»¥ä¸æ‰“ç®—ä½¿ç”¨SSçš„æ–¹æ³•ï¼Œè™½ç„¶SSè®¾ç½®èµ·æ¥æ¯”è¾ƒç®€å•ã€‚</p>
<p>æœ¬ç¯‡çš„ç›®çš„åœ¨äºè®¾ç½®openwrt VPNæœåŠ¡å™¨ä½œä¸ºAndroid å’Œ iPhone/iPadçš„ç½‘å…³ï¼Œè€Œæ— éœ€åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé¢å¤–æ·»åŠ è½¯ä»¶ã€‚</p>
<h2 id="å†å†å‡ºå‘"><a class="header-anchor" href="#å†å†å‡ºå‘"></a>å†å†å‡ºå‘</h2>
<p>æ˜ç¡®æˆ‘ç°åœ¨æƒ³è¦çš„ï¼Œxauth+ipsec PSKã€‚æ ¹æ®å‰ä¸¤è½®çš„å®æ“ï¼Œæ”¶è·äº†ä¸€ç‚¹ç»éªŒï¼š</p>
<ul>
<li>LACï¼šç›¸å½“äºå®¢æˆ·ç«¯</li>
<li>LNSï¼šç›¸å½“äºæœåŠ¡ç«¯ï¼Œæˆ‘åº”è¯¥æ­å»ºçš„æ˜¯æ­¤è®¾ç½®ï¼Œæˆ‘çš„æœåŠ¡ç”¨IPå³right</li>
<li>PSAï¼šéœ€è¦ç”Ÿæˆè¯ä¹¦å¹¶ä¼ é€åˆ°ç»ˆç«¯å®‰è£…ï¼Œæ±—ğŸ˜“ï¼Œæˆ‘è¦æ˜¯èƒ½ä¼ æ–‡ä»¶ä»€ä¹ˆçš„ï¼Œå°±ä¸éœ€è¦è§£å†³é—®é¢˜äº†ï¼æˆ‘è¦çš„æ˜¯ç»ˆç«¯å¼€ç®±å³ç”¨çš„VPN</li>
<li>strongswanï¼šåœ¨ä¸éœ€è¦l2tpçš„å‰æä¸‹ï¼Œå¯ä»¥å®Œå…¨èƒœä»»éœ€æ±‚ã€‚æ‰€ä»¥å®ƒçš„è®¾ç½®æ–‡æ¡£å€¼å¾—ä¸€è¯»ã€‚</li>
<li>éœ€è¦å®Œæ•´çš„dnsmasq</li>
<li>éœ€è¦æ·»åŠ ä¸€ä¸ªç‹¬ç«‹çš„æ¥å£</li>
<li>éœ€è¦æ›´æ”¹çš„é…ç½®æ–‡ä»¶ï¼š<code>/etc/config/{network/firewall}</code>, <code>/etc/{firewall.user/ipsec.secrets/strongswan.conf}</code>, <code>/etc/init.d/ipsec</code></li>
<li>éœ€è¦è¯ä¹¦å·¥å…·</li>
</ul>
<p>å†å‡ºå‘å‰ï¼Œåˆ¶å®šæœ¬æ­¤å‡ºå‘çš„è·¯çº¿ï¼š</p>
<ol>
<li>æ¢³ç†<strong>hwdsl2</strong><sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup>çš„è‡ªåŠ¨è„šæœ¬ï¼Œå°†è¿‡ç¨‹å†™åœ¨ä¸‹é¢</li>
<li>å¯¹æ¯”<strong>openwrté…ç½®l2tp/ipsec VPN II</strong> çš„è®¾ç½®ï¼Œæ”¹æˆ<strong>openwrt</strong>çš„é€‚ç”¨è„šæœ¬æˆ–æ–¹æ³•ã€‚</li>
<li>å¯¹ç…§<strong>strongswan</strong>çš„[wikiæ–‡æ¡£][2]ï¼Œè¯¦ç»†æ³¨é‡Šè„šæœ¬</li>
</ol>
<h2 id="æ¢³ç†è‡ªåŠ¨è„šæœ¬"><a class="header-anchor" href="#æ¢³ç†è‡ªåŠ¨è„šæœ¬"></a>æ¢³ç†è‡ªåŠ¨è„šæœ¬</h2>
<p>license : creative commons attribution-sharealike 3.0</p>
<p>éœ€è¦è‡ªå®šä¹‰çš„å˜é‡ï¼š</p>
<ul>
<li>VPN_IPSEC_PSK=YOUR_IPSEC_PSK=â€™â€™</li>
<li>VPN_USER=YOUR_USERNAME=â€™â€™</li>
<li>VPN_PASSWORD=YOUR_PASSWORD=â€™â€™</li>
</ul>
<h3 id="vpnsetup-shä¸»æ–‡ä»¶"><a class="header-anchor" href="#vpnsetup-shä¸»æ–‡ä»¶"></a>vpnsetup.shä¸»æ–‡ä»¶</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">!/bin/sh</span></span><br><span class="line"></span><br><span class="line">export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"</span><br><span class="line"></span><br><span class="line">SYS_DT=$(date +%F-%T) #å½“å‰æ—¶é—´ï¼Œ$()å¯ä»¥å°†å†…å®¹æ‰§è¡Œç»“æœèµ‹å€¼ç»™å˜é‡</span><br><span class="line"></span><br><span class="line">vpnsetup "$@" #æœ¬è„šæœ¬æ‰§è¡Œä¸éœ€è¦é¢å¤–å‚æ•°ï¼Œ$@=''</span><br><span class="line">exit 0</span><br></pre></td></tr></table></figure>
<h3 id="vpnsetup-å‡½æ•°"><a class="header-anchor" href="#vpnsetup-å‡½æ•°"></a>vpnsetup()å‡½æ•°</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="æ‰‹åŠ¨æµç¨‹"><a class="header-anchor" href="#æ‰‹åŠ¨æµç¨‹"></a>æ‰‹åŠ¨æµç¨‹</h2>
<h3 id="å®‰è£…éœ€æ±‚åŒ…"><a class="header-anchor" href="#å®‰è£…éœ€æ±‚åŒ…"></a>å®‰è£…éœ€æ±‚åŒ…</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opkg update</span><br><span class="line">opkg install wget dnsutils openssl iptables iproute2 gawk grep sed net-tools</span><br></pre></td></tr></table></figure>
<p><strong>å¯¹äºæ‰€åˆ—è½¯ä»¶ï¼Œåº”å¯¹æ¯”ç³»ç»Ÿä¸­æ˜¯å¦å·²ç»å­˜åœ¨èƒ½å¤Ÿæ›¿ä»£ä½¿ç”¨çš„å‘½ä»¤ã€‚æŸ¥è¯åå†ç»§ç»­</strong></p>
<h3 id="è®¾ç½®å˜é‡"><a class="header-anchor" href="#è®¾ç½®å˜é‡"></a>è®¾ç½®å˜é‡</h3>
<p>æŒ‡å®šå…¬å…±ipï¼šPUBLIC_IP=?ï¼Œé€šè¿‡æ‰‹æ®µæ‹¿åˆ°å…¬ç½‘IP</p>
<h3 id="å®‰è£…vpnè½¯ä»¶"><a class="header-anchor" href="#å®‰è£…vpnè½¯ä»¶"></a>å®‰è£…VPNè½¯ä»¶</h3>
<p>list:</p>
<ul>
<li>libnss3-dev</li>
<li>libnspr4-dev</li>
<li>pkg-config</li>
<li>libpam0g-dev</li>
<li>libcap-ng-dev</li>
<li>libcap-ng-utils</li>
<li>libselinux1-dev</li>
<li>libcurl4-nss-dev</li>
<li>flex</li>
<li>bison</li>
<li>gcc</li>
<li>make</li>
<li>libnss3-tools</li>
<li>libevent-dev</li>
<li>ppp</li>
<li>xl2tpd</li>
</ul>
<h3 id="å®‰è£…sshé˜²æŠ¤è½¯ä»¶"><a class="header-anchor" href="#å®‰è£…sshé˜²æŠ¤è½¯ä»¶"></a>å®‰è£…SSHé˜²æŠ¤è½¯ä»¶</h3>
<ul>
<li>fail2ban</li>
</ul>
<h3 id="åˆ¶ä½œå¹¶å®‰è£…libreswan"><a class="header-anchor" href="#åˆ¶ä½œå¹¶å®‰è£…libreswan"></a>åˆ¶ä½œå¹¶å®‰è£…libreswan</h3>
<p>ğŸ˜“ï¼Œç‹‚åğŸ¤®ï¼Œçœ‹æ¥æˆ‘åªéœ€è¦å®‰è£…strongswanå°±å¥½äº†</p>
<h3 id="ç¼–å†™vpné…ç½®æ–‡ä»¶"><a class="header-anchor" href="#ç¼–å†™vpné…ç½®æ–‡ä»¶"></a>ç¼–å†™VPNé…ç½®æ–‡ä»¶</h3>
<p>å…ˆæ˜¯å…³äºl2tpçš„ï¼Œè·³è¿‡ä¸çœ‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XAUTH_NET=&quot;192.168.43.0/24&quot;</span><br><span class="line"></span><br><span class="line">XAUTH_POOL=&quot;192.168.43.10-192.168.43.250&quot;</span><br><span class="line"></span><br><span class="line">DNS_SRVS=&quot;8.8.8.8 4.4.4.4&quot;</span><br><span class="line"></span><br><span class="line">[ -n &quot;$VPN_DNS_SRV1&quot; ] &amp;&amp; [ -z &quot;$VPN_DNS_SRV2&quot; ] &amp;&amp; DNS_SRVS=&quot;$DNS_SRV1&quot;</span><br></pre></td></tr></table></figure>
<h3 id="etc-ipsec-conf"><a class="header-anchor" href="#etc-ipsec-conf"></a>/etc/ipsec.conf</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">version 2.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">config setup</span><br><span class="line"></span><br><span class="line">  virtual-private=%v4:10.0.0.0/8,%v4:192.168.0.0/16,%v4:172.16.0.0/12,%v4:!$L2TP_NET,%v4:!$XAUTH_NET</span><br><span class="line"></span><br><span class="line">  protostack=netkey</span><br><span class="line"></span><br><span class="line">  interfaces=%defaultroute</span><br><span class="line"></span><br><span class="line">  uniqueids=no</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">conn shared</span><br><span class="line"></span><br><span class="line">  left=%defaultroute</span><br><span class="line"></span><br><span class="line">  leftid=$PUBLIC_IP</span><br><span class="line"></span><br><span class="line">  right=%any</span><br><span class="line"></span><br><span class="line">  encapsulation=yes</span><br><span class="line"></span><br><span class="line">  authby=secret</span><br><span class="line"></span><br><span class="line">  pfs=no</span><br><span class="line"></span><br><span class="line">  rekey=no</span><br><span class="line"></span><br><span class="line">  keyingtries=5</span><br><span class="line"></span><br><span class="line">  dpddelay=30</span><br><span class="line"></span><br><span class="line">  dpdtimeout=120</span><br><span class="line"></span><br><span class="line">  dpdaction=clear</span><br><span class="line"></span><br><span class="line">  ikev2=never</span><br><span class="line"></span><br><span class="line">  ike=aes256-sha2,aes128-sha2,aes256-sha1,aes128-sha1,aes256-sha2;modp1024,aes128-sha1;modp1024</span><br><span class="line"></span><br><span class="line">  phase2alg=aes_gcm-null,aes128-sha1,aes256-sha1,aes256-sha2_512,aes128-sha2,aes256-sha2</span><br><span class="line"></span><br><span class="line">  sha2-truncbug=no</span><br><span class="line"></span><br><span class="line">conn xauth-psk</span><br><span class="line"></span><br><span class="line">  auto=add</span><br><span class="line"></span><br><span class="line">  leftsubnet=0.0.0.0/0</span><br><span class="line"></span><br><span class="line">  rightaddresspool=$XAUTH_POOL</span><br><span class="line"></span><br><span class="line">  modecfgdns=$DNS_SRVS</span><br><span class="line"></span><br><span class="line">  leftxauthserver=yes</span><br><span class="line"></span><br><span class="line">  rightxauthclient=yes</span><br><span class="line"></span><br><span class="line">  leftmodecfgserver=yes</span><br><span class="line"></span><br><span class="line">  rightmodecfgclient=yes</span><br><span class="line"></span><br><span class="line">  modecfgpull=yes</span><br><span class="line"></span><br><span class="line">  xauthby=file</span><br><span class="line"></span><br><span class="line">  ike-frag=yes</span><br><span class="line"></span><br><span class="line">  cisco-unity=yes</span><br><span class="line"></span><br><span class="line">  also=shared</span><br></pre></td></tr></table></figure>
<h3 id="etc-ipsec-secrets"><a class="header-anchor" href="#etc-ipsec-secrets"></a>/etc/ipsec.secrets</h3>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%any  %any  : PSK &quot;$VPN_IPSEC_PSK&quot;</span><br></pre></td></tr></table></figure>
<h3 id="etc-ppp-chap-secrets"><a class="header-anchor" href="#etc-ppp-chap-secrets"></a>/etc/ppp/chap-secrets</h3>
<p>ä¼¼ä¹å’Œl2tpdæœ‰å…³ï¼ŒæŸ¥è¯åä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;$VPN_USER&quot; l2tpd &quot;$VPN_PASSWORD&quot; *</span><br></pre></td></tr></table></figure>
<h3 id="å†™å…¥-etc-ipsec-d-passwd"><a class="header-anchor" href="#å†™å…¥-etc-ipsec-d-passwd"></a>å†™å…¥ /etc/ipsec.d/passwd</h3>
<p>è¿™ä¸ªä¹‹å‰æ²¡æœ‰æ¥è§¦è¿‡ï¼Œä¼¼ä¹æ˜¯å°†ç¼–ç åçš„å¯†ç å†™å…¥æ–‡ä»¶ä¾›xauthä½¿ç”¨ã€‚</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VPN_PASSWORD_ENC=$(openssl passwd -1 "$VPN_PASSWORD")</span><br><span class="line">conf_bk "/etc/ipsec.d/passwd" #å¦‚æœå­˜åœ¨å¤‡ä»½æ–‡ä»¶</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/ipsec.d/passwd &lt;&lt;EOF</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash">VPN_USER:<span class="variable">$VPN_PASSWORD_ENC</span>:xauth-psk</span></span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<h3 id="etc-sysctl-conf"><a class="header-anchor" href="#etc-sysctl-conf"></a>/etc/sysctl.conf</h3>
<p>æ¯ä¸€ä¸ªæ“ä½œéƒ½åº”è¯¥å¤‡ä»½æ–‡ä»¶ã€‚å¤‡ä»½æ–‡ä»¶å</p>
<p>64ä½:</p>
<pre><code>SHM_MAX=68719476736

SHM_ALL=4294967296
</code></pre>
<p>32ä½ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHM_MAX=4294967295</span><br><span class="line"></span><br><span class="line">SHM_ALL=268435456</span><br></pre></td></tr></table></figure>
<p>æ–‡ä»¶æ”¹åŠ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># Added by hwdsl2 VPN script</span><br><span class="line"></span><br><span class="line">kernel.msgmnb = 65536</span><br><span class="line"></span><br><span class="line">kernel.msgmax = 65536</span><br><span class="line"></span><br><span class="line">kernel.shmmax = $SHM_MAX</span><br><span class="line"></span><br><span class="line">kernel.shmall = $SHM_ALL</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.all.accept_source_route = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.all.accept_redirects = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.all.send_redirects = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.all.rp_filter = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.default.accept_source_route = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.default.accept_redirects = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.default.send_redirects = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.default.rp_filter = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.$NET_IFACE.send_redirects = 0</span><br><span class="line"></span><br><span class="line">net.ipv4.conf.$NET_IFACE.rp_filter = 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">net.core.wmem_max = 12582912</span><br><span class="line"></span><br><span class="line">net.core.rmem_max = 12582912</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_rmem = 10240 87380 12582912</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_wmem = 10240 87380 12582912</span><br></pre></td></tr></table></figure>
<h3 id="æ›´æ–°iptables"><a class="header-anchor" href="#æ›´æ–°iptables"></a>æ›´æ–°iptables</h3>
<h2 id="åè®°"><a class="header-anchor" href="#åè®°"></a>åè®°</h2>
<h2 id="äº‹æƒ…æ²¡åšå®Œ-ç„¶åæˆ‘æ”¾å¼ƒäº†-å› ä¸ºæˆ‘åšäº†ä¸‹é¢è¿™ä»¶äº‹-penwrté…ç½®ss-server"><a class="header-anchor" href="#äº‹æƒ…æ²¡åšå®Œ-ç„¶åæˆ‘æ”¾å¼ƒäº†-å› ä¸ºæˆ‘åšäº†ä¸‹é¢è¿™ä»¶äº‹-penwrté…ç½®ss-server"></a>äº‹æƒ…æ²¡åšå®Œï¼Œç„¶åæˆ‘æ”¾å¼ƒäº†ï¼Œå› ä¸ºæˆ‘åšäº†ä¸‹é¢è¿™ä»¶äº‹ <a href="openwrt-install-l2tp-ipsec-IV">penwrté…ç½®ss-server</a></h2>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header-anchor" href="#å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2>
<p>[2]:<a href="https://wiki.strongswan.org/projects/strongswan/wiki" target="_blank" rel="noopener">https://wiki.strongswan.org/projects/strongswan/wiki</a>	â€œâ€œstrongswançš„æ–‡æ¡£â€â€</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a href="https://github.com/hwdsl2/setup-ipsec-vpn/blob/master/vpnsetup.sh" target="_blank" rel="noopener">IPsec VPN æœåŠ¡å™¨ä¸€é”®å®‰è£…è„šæœ¬</a> <a href="#fnref1" class="footnote-backref">â†©ï¸</a></p>
</li>
</ol>
</section>
</div><div class="tags"><a href="/tags/linux/">linux</a><a href="/tags/openwrt-lede/">openwrt/lede</a><a href="/tags/vpn/">vpn</a><a href="/tags/ipsec/">ipsec</a></div><div class="post-nav"><a class="pre" href="/posts/2ac5ecda.html">penwrté…ç½®ss-server</a><a class="next" href="/posts/c738ae61.html">penwrté…ç½®l2tp/ipsec VPN II</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://justin-x.github.io"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> åˆ†ç±»</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%AE%B0/">æ‚è®°</a><span class="category-list-count">1</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E8%AE%B0/%E5%AE%B6%E6%9C%89%E5%84%BF%E5%A5%B3/">å®¶æœ‰å„¿å¥³</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%9E%8E%E6%8A%98%E8%85%BE/">çæŠ˜è…¾</a><span class="category-list-count">9</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> æ ‡ç­¾</i></div><div class="tagcloud"><a href="/tags/hexo/" style="font-size: 15px;">hexo</a> <a href="/tags/test/" style="font-size: 15px;">test</a> <a href="/tags/Alpine/" style="font-size: 15px;">Alpine</a> <a href="/tags/nodejs/" style="font-size: 15px;">nodejs</a> <a href="/tags/npm/" style="font-size: 15px;">npm</a> <a href="/tags/linux/" style="font-size: 15px;">linux</a> <a href="/tags/openwrt-lede/" style="font-size: 15px;">openwrt/lede</a> <a href="/tags/vpn/" style="font-size: 15px;">vpn</a> <a href="/tags/ipsec/" style="font-size: 15px;">ipsec</a> <a href="/tags/nvm/" style="font-size: 15px;">nvm</a> <a href="/tags/%E5%AD%A9%E5%AD%90/" style="font-size: 15px;">å­©å­</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> æœ€è¿‘æ–‡ç« </i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/posts/1e400e37.html">æ‰‹åŠ¨é…ç½®ä¸€ä¸ªmarkdown-itç¯å¢ƒ</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/4d7ef6c2.html">Alpine wsl å®‰è£…nvmå’Œnpm</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/a0c259b2.html">hexoç¯å¢ƒçš„æ­å»º</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2ac5ecda.html">penwrté…ç½®ss-server</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e7707fd9.html">penwrté…ç½®l2tp/ipsec VPN III</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/c738ae61.html">penwrté…ç½®l2tp/ipsec VPN II</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/e06ca514.html">penwrté…ç½®l2tp/ipsec VPN I</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/7ab936e4.html">pinyinduben</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/9c534a52.html">test markdown 2</a></li><li class="post-list-item"><a class="post-list-link" href="/posts/2cc78fb1.html">test markdown</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> å‹æƒ…é“¾æ¥</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright Â© 2019 <a href="/." rel="nofollow">Xçš„ç¬”è®°æœ¬.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>